# 软件设计文档
## 一、前端（MiniChat）
### 1、技术选型以及理由
前端采用Android作为开发工具，使用腾讯信鸽作为主要的消息处理

* 腾讯信鸽：消息接受处理
* SQLite：本地数据库管理

腾讯信鸽推送是专业免费的第三方推送工具,能保证消息稳定到达和接收，并提供了相应的类作为接收消息后的处理。能在保证消息及时有效到达的同时保证省电省流量，提高到达率，提升点击效果转化。

SQLite是一个开源的嵌入式关系数据库，内置在Android中。适用于嵌入式系统，嵌入到使用它的应用程序中。占用非常少，运行高效可靠，可移植性好。提供了零配置（zero-configuration）运行模式。SQLite数据库不仅提高了运行效率，而且屏蔽了数据库使用和管理的复杂性，程序仅需要进行最基本的数据操作，其他操作可以交给进程内部的数据库引擎完成。

### 2、架构设计
前端项目主要涉及应用界面和业务逻辑开发以及产品构建。本次实验的前端代码以及资源部分都放在MiniChat\app\src文件夹中，主要需要关注的是以下几部分：

* main\java\com\example\caitzh\minichat：这个文件夹下存放java类，负责业务逻辑的处理
* main\res:资源文件夹，存放图片等静态资源以及页面布局文件（layout文件夹）
* AndroidManifest.xml：项目配置文件，对java类进行配置管理

### 3、模块划分
根据页面和业务逻辑，我们得到以下页面转换关系图
![](http://i.imgur.com/bdk4zLV.png)

根据页面转换关系图，我们主要分成聊天界面相关的Chat文件夹；Friends存放好友列表，添加好友等页面；Personal中存放个人信息页面以及相关类。在前端开发中，我们还需要对部分页面添加适配器进行页面与数据的交互，这部分放在Adapter中。使用数据库对这部分对本地数据进行管理，这部分放在MyDB文件夹中。同时，提供了一些公用的方法类用于图片获取和http连接交互等，这部分放在Util中。最后，还有自定义控件以及部分用例类的view文件夹。所有的文件，都是为了Activity页面的展示而服务。

综合得到以下的文件树：

```
├─app: 安卓端代码
   ├─src: 源代码
   │  ├─main
   │     ├─res：资源文件
   │     │  ├─anmi:二维动画文件夹
   │     │  ├─drawble:自定义样式所在文件夹
   │     │  ├─layout:页面布局所在文件夹
   │     │  ├─menu:菜单所在文件夹
   │     │  ├─mipmap:静态图片所在文件夹
   │     │  └─values:一些长度值、RGB值定义所在文件夹
   │     ├─java: java 代码
   │   	 │  ├─Adapter：页面是配器文件夹
   │   	 │  ├─Chat:聊天页面类相关文件夹
   │   	 │  ├─Friends：好友相关类文件夹
   │   	 │  ├─MyDB：数据库类文件夹
   │   	 │  ├─Personal：个人信息相关类文件夹
   │   	 │  ├─Util：通用方法类文件夹
   │   	 │  └─view：自定义控件以及部分用例类文件夹
   │     └─AndroidManifest.xml:整个项目的配置文件，里面包括布局服务的定义以及Activity栈方式的定义
   └─libs：第三方SDK
```
	

### 4、设计模式
* 单例模式：在管理 `cookie` 的时候，由于需要保证整个项目各个使用的 `cookie` 一致，因此需要保证只能存在一个 `CookieManager` 类的实例，因此我们采用了单例模式，当需要用到 `CookieManager` 时，检查其是否存在，不存在则创建一个出来，若已经存在则直接使用
* 面向对象编程：整个项目都是采用面向对象的思想，无论是每一个界面（`activity`）、还是数据库访问，或者是通用的工具方法，在项目中都是以类的形式存在，通过调用类的方法来实现对其访问。各个类之间相互协作，条理分明。分工时可以按功能点和类的实现分配任务，约定好彼此对外提供的接口，可以实现并行开发，减少彼此之间的时间依赖，提高开发效率，又易于调试。

## 服务端
### 1. 技术选型及其理由
服务端采用的技术栈为Flask+MySQL

* Flask：使用 Python 编写的轻量级 Web 应用框架，其 WSGI 工具箱采用 Werkzeug
* MySQL：最流行的关系型数据库管理系统之一。

Flask 是一个使用 Python 编写的轻量级Web应用框架，被称为 `microframework`， 因为它使用简单的核心，用 `extension` 增加其他功能。Flask 没有默认使用的数据库、窗体验证工具。 然而，Flask保留了扩增的弹性，可以用 `Flask-extension` 加入这些功能：ORM、窗体验证工具、文件上传、各种开放式身份验证技术。因此 Flask 自由、灵活、可扩展性强， 其丰富的插件可以让我们很容易定制出其他功能，大大降低开发难度，无需重复造轮子。例如 `Flask-login` 可以简单地实现用户登录会话的管理，使用 `flask-sqlalchemy` 可以方便地连接、访问 `Mysql` 数据库

MySQL 是一种关系数据库管理系统，关系数据库将数据保存在不同的表中，而不是将所有数据放在一个大仓库内，这样就增加了速度并提高了灵活性。其体积小、速度快、总体拥有成本低，是中小型项目的很好选择。

### 2. 架构设计
服务端开发主要涉及用户的登录管理，好友关系的管理，消息的发送等，为客户端提供接口。
主要包括：

* model：数据库的模型，对应于 `MySQL` 里的各个表
* router: 路由管理，实现服务端提供给客户端的各种接口（API）
* myemail: 实现发送邮件，主要用于用户注册和找回密码时的邮箱验证码验证

### 3. 模块划分
根据以上设计，划分为数据库模块，路由模块，邮件模块

目录结构如下：
```
├─app：服务端主要代码
│    ├─static：保存图片等资源文件
│    ├─models.py: 数据库模型
│    ├─router.py: 路由管理
│    └─myemail.py: 邮件发送模块
├─venv: virtualenv 虚拟 python 运行环境
├─server.py: 服务器启动代码
├─server.conf: 服务器配置文件
├─requirements.txt：项目依赖列表
└─API.md： 服务端提供的接口描述及使用说明
```

### 4. 设计模式
* 工厂模式：在 `app/__init__.py` 中应用了工厂模式创建一个 `Flask` 对象，对其进行各种必要的初始化配置之后再将其返回，这样外部获取这个对象之后便能直接使用。还能根据不同情况进行不同的配置，即根据不同需求，工厂返回不同的产品。
* 面向对象编程：在项目中处处使用了面向对象思想，大至是数据库模型，邮件模块，小到验证码，都将其封装成一个类，对外提供接口。外部可以通过这些接口来实现对其访问。这样项目耦合度低，修改类的实现时可以保持接口不变，无需更改外部代码。并且易于维护，外部对类的访问必定只能通过接口，有利于减少出错的机会以及错误的定位。


